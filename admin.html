<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Monkey Ranch MX</title>
    <link rel="icon" type="image/png" href="icono-monkey.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header img {
            max-width: 150px;
            margin-bottom: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .stat-card h3 {
            color: #b8242f;
            font-size: 3em;
            margin-bottom: 10px;
        }

        .stat-card p {
            color: #666;
            font-size: 1.1em;
        }

        .contacts-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #b8242f;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            box-shadow: 0 0 15px rgba(184, 36, 47, 0.3);
        }

        .refresh-btn {
            background: #b8242f;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #a01e27;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(184, 36, 47, 0.5);
        }

        .contacts-grid {
            display: grid;
            gap: 20px;
        }

        .contact-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #b8242f;
            transition: all 0.3s;
            animation: fadeIn 0.5s;
        }

        .contact-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .contact-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .contact-date {
            color: #666;
            font-size: 0.9em;
        }

        .contact-email {
            color: #b8242f;
            font-weight: 600;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .contact-phone {
            color: #b8242f;
            font-weight: 600;
            margin-bottom: 15px;
            word-break: break-all;
        }

        .contact-phone a {
            color: #b8242f;
            text-decoration: none;
            transition: all 0.3s;
        }

        .contact-phone a:hover {
            text-decoration: underline;
            color: #a01e27;
        }

        .vip-field a {
            color: #b8242f;
            text-decoration: none;
            transition: all 0.3s;
        }

        .vip-field a:hover {
            text-decoration: underline;
            color: #a01e27;
        }

        .contact-message {
            background: white;
            padding: 15px;
            border-radius: 8px;
            color: #555;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: #b8242f;
        }

        .error {
            background: #ff4757;
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .no-contacts {
            text-align: center;
            padding: 50px;
            color: #999;
            font-size: 1.2em;
        }

        /* Modal styles for viewing proofs */
        .proof-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s;
        }

        .proof-modal-content {
            position: relative;
            background-color: white;
            margin: auto;
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90vh;
            overflow: auto;
            top: 50%;
            transform: translateY(-50%);
        }

        .proof-modal-close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            color: #b8242f;
        }

        .proof-modal-close:hover {
            color: #a01e27;
        }

        .proof-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            margin-top: 20px;
        }

        .btn-view-proof {
            background: #b8242f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .btn-view-proof:hover {
            background: #a01e27;
            transform: scale(1.05);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .stat-card h3 {
                font-size: 2em;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 12px 24px;
            font-size: 1em;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: #b8242f;
            border-bottom-color: #b8242f;
            font-weight: bold;
        }

        .tab-btn:hover {
            color: #b8242f;
        }

        .vip-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #b8242f;
            transition: all 0.3s;
            animation: fadeIn 0.5s;
        }

        .vip-card .vip-info {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .vip-field {
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .vip-field strong {
            color: #b8242f;
            display: block;
            margin-bottom: 5px;
        }

        .inscription-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #b8242f;
            transition: all 0.3s;
            animation: fadeIn 0.5s;
        }

        .inscription-details {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
            width: calc(50% - 5px);
            display: inline-block;
        }

        .delete-btn:hover {
            background: #cc0000;
            transform: scale(1.02);
        }

        .delete-btn:active {
            transform: scale(0.98);
        }

        .generate-qr-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 15px;
            margin-right: 10px;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.3s;
            width: calc(50% - 5px);
            display: inline-block;
        }

        .generate-qr-btn:hover {
            background: #218838;
            transform: scale(1.02);
        }

        .generate-qr-btn:active {
            transform: scale(0.98);
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .login-box {
            background: white;
            padding: 50px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
        }

        .login-box img {
            max-width: 150px;
            display: block;
            margin: 0 auto 30px;
        }

        .login-box h2 {
            text-align: center;
            color: #b8242f;
            margin-bottom: 30px;
            font-size: 1.8em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input {
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .login-form input:focus {
            outline: none;
            border-color: #b8242f;
            box-shadow: 0 0 10px rgba(184, 36, 47, 0.2);
        }

        .login-form button {
            padding: 12px;
            background: #b8242f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-form button:hover {
            background: #a01e27;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(184, 36, 47, 0.4);
        }

        .login-error {
            color: #ff4757;
            text-align: center;
            font-size: 0.9em;
            margin-top: 15px;
        }

        .admin-content {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <img src="logo-monkey.png" alt="Monkey Ranch Logo">
            <h2>Admin</h2>
            <form class="login-form" id="loginForm">
                <input type="text" id="username" placeholder="Usuario" required>
                <input type="password" id="password" placeholder="Contrase√±a" required>
                <button type="submit">Ingresar</button>
            </form>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Admin Content -->
    <div id="adminContent" class="admin-content">
    <div class="container">
        <div class="header">
            <img src="logo-monkey.png" alt="Monkey Ranch Logo">
            <h1> Panel de Administraci√≥n</h1>
            <p>Gesti√≥n general - Monkey Ranch MX</p>            <button class="refresh-btn" onclick="logout()" style="margin-top: 20px; background: #a01e27;">üö™ Cerrar Sesi√≥n</button>        </div>

        <div class="stats">
            <div class="stat-card">
                <h3 id="totalContacts">0</h3>
                <p>Total de Contactos</p>
                <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Hoy: <strong id="todayContacts" style="color: #b8242f;">0</strong></p>
            </div>
            <div class="stat-card">
                <h3 id="totalVip">0</h3>
                <p>Total VIP</p>
                <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Hoy: <strong id="todayVip" style="color: #b8242f;">0</strong></p>
            </div>
            <div class="stat-card">
                <h3 id="totalInscripciones">0</h3>
                <p>Total Inscripciones</p>
                <p style="color: #999; font-size: 0.9em; margin-top: 10px;">Hoy: <strong id="todayInscripciones" style="color: #b8242f;">0</strong></p>
            </div>
        </div>

        <div class="contacts-container">
            <div class="controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç Buscar...">
                </div>
                <button class="refresh-btn" onclick="loadAllData()">üîÑ Actualizar</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('contacts')">üìã Contactos</button>
                <button class="tab-btn" onclick="switchTab('vip')">üëë VIP</button>
                <button class="tab-btn" onclick="switchTab('inscripciones')">üèçÔ∏è Inscripciones</button>
                <button class="tab-btn" onclick="switchTab('tickets')">üé´ Tickets Generales</button>
                <button class="tab-btn" onclick="switchTab('tickets_vip')">üé´üëë Tickets VIP</button>
                <button class="tab-btn" onclick="switchTab('parking')">üÖøÔ∏è Estacionamiento</button>
                <button class="tab-btn" onclick="switchTab('comprobantes_generales')">üßæ Comprobantes Generales</button>
                <button class="tab-btn" onclick="switchTab('comprobantes_vip')">üßæüëë Comprobantes VIP</button>
                <button class="tab-btn" onclick="switchTab('comprobantes_parking')">üßæüÖøÔ∏è Comprobantes Estacionamiento</button>
                <button class="tab-btn" onclick="switchTab('codigos')">üîê C√≥digos</button>
            </div>

            <div id="contactsContent" class="tab-content">
                <div class="loading">‚è≥ Cargando contactos...</div>
            </div>

            <div id="vipContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando VIP...</div>
            </div>

            <div id="inscripcionesContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando inscripciones...</div>
            </div>

            <div id="ticketsContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando tickets...</div>
            </div>

            <div id="tickets_vipContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando tickets VIP...</div>
            </div>

            <div id="parkingContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando estacionamiento...</div>
            </div>

            <div id="comprobantes_generalesContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando comprobantes...</div>
            </div>

            <div id="comprobantes_vipContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando comprobantes VIP...</div>
            </div>

            <div id="comprobantes_parkingContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando comprobantes estacionamiento...</div>
            </div>

            <div id="codigosContent" class="tab-content" style="display:none;">
                <div class="loading">‚è≥ Cargando c√≥digos...</div>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Credenciales de acceso
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'monkeyranch123';

        // Verificar si ya est√° autenticado
        window.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('adminAuthenticated')) {
                showAdminPanel();
            } else {
                showLoginForm();
            }
        });

        // Login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                errorDiv.textContent = '';
                showAdminPanel();
            } else {
                errorDiv.textContent = '‚ùå Usuario o contrase√±a incorrectos';
                document.getElementById('password').value = '';
            }
        });

        function showLoginForm() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminContent').style.display = 'none';
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadAllData();
        }

        function logout() {
            sessionStorage.removeItem('adminAuthenticated');
            document.getElementById('loginForm').reset();
            showLoginForm();
        }

        // Detectar si estamos en desarrollo y usar localhost, de lo contrario usar API remota
        const API_BASE_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000'
            : 'https://monkey-ranch-api.onrender.com';

        let allContacts = [];
        let allVip = [];
        let allInscripciones = [];
        let allTickets = [];
        let allTicketsVip = [];
        let allParking = [];
        let allCodigos = [];
        let currentTab = 'contacts';
        
        // Store proofs in memory to avoid HTML attribute size limits
        let proofsMap = {};
        let proofCounter = 0;

        // Cargar datos al iniciar
        window.addEventListener('DOMContentLoaded', loadAllData);

        // Buscar en tiempo real
        document.getElementById('searchInput').addEventListener('input', filterData);

        async function loadAllData() {
            await loadContacts();
            await loadVip();
            await loadInscripciones();
            await loadTickets();
            await loadTicketsVip();
            await loadParking();
            updateStats();
        }

        async function loadContacts() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/contacts`);
                const data = await response.json();

                if (data.success) {
                    allContacts = data.data;
                    displayContacts(allContacts);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadVip() {
            try {
                const response = await fetch('/api/vip');
                const data = await response.json();

                if (data.success) {
                    allVip = data.data;
                    displayVip(allVip);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadInscripciones() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/inscripciones`);
                const data = await response.json();

                if (data.success) {
                    allInscripciones = data.data;
                    displayInscripciones(allInscripciones);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadTickets() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/ticket-purchases`);
                const data = await response.json();

                if (data.success) {
                    allTickets = data.data;
                    displayTickets(allTickets);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadTicketsVip() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/vip-purchases`);
                const data = await response.json();

                if (data.success) {
                    allTicketsVip = data.data;
                    displayTicketsVip(allTicketsVip);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadParking() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/parking-purchases`);
                const data = await response.json();

                if (data.success) {
                    allParking = data.data;
                    displayParking(allParking);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function updateStats() {
            document.getElementById('totalContacts').textContent = allContacts.length;
            document.getElementById('totalVip').textContent = allVip.length;
            document.getElementById('totalInscripciones').textContent = allInscripciones.length;

            // Contar registros de hoy
            const today = new Date().toDateString();
            
            const todayContactsCount = allContacts.filter(contact => {
                const contactDate = new Date(contact.fecha_creacion).toDateString();
                return contactDate === today;
            }).length;

            const todayVipCount = allVip.filter(vip => {
                const vipDate = new Date(vip.fecha_creacion).toDateString();
                return vipDate === today;
            }).length;

            const todayInscripcionesCount = allInscripciones.filter(insc => {
                const inscDate = new Date(insc.fecha_creacion).toDateString();
                return inscDate === today;
            }).length;

            document.getElementById('todayContacts').textContent = todayContactsCount;
            document.getElementById('todayVip').textContent = todayVipCount;
            document.getElementById('todayInscripciones').textContent = todayInscripcionesCount;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            event.target.classList.add('active');
            
            if (tab === 'contacts') {
                document.getElementById('contactsContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar por nombre, email o mensaje...';
            } else if (tab === 'vip') {
                document.getElementById('vipContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar VIP por nombre, email o whatsapp...';
            } else if (tab === 'inscripciones') {
                document.getElementById('inscripcionesContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar inscripciones por nombre o email...';
            } else if (tab === 'tickets') {
                document.getElementById('ticketsContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar tickets por nombre o email...';
            } else if (tab === 'tickets_vip') {
                document.getElementById('tickets_vipContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar tickets VIP por nombre o email...';
            } else if (tab === 'parking') {
                document.getElementById('parkingContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar estacionamiento por nombre, email o placas...';
            } else if (tab === 'comprobantes_generales') {
                document.getElementById('comprobantes_generalesContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar comprobantes por nombre o email...';
                loadProofsGenerales();
            } else if (tab === 'comprobantes_vip') {
                document.getElementById('comprobantes_vipContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar comprobantes VIP por nombre o email...';
                loadProofsVIP();
            } else if (tab === 'comprobantes_parking') {
                document.getElementById('comprobantes_parkingContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar comprobantes estacionamiento por nombre o placas...';
                loadProofsParking();
            } else if (tab === 'codigos') {
                document.getElementById('codigosContent').style.display = 'block';
                document.getElementById('searchInput').placeholder = 'üîç Buscar c√≥digos...';
                loadCodigos();
            }
            
            document.getElementById('searchInput').value = '';
        }

        function displayContacts(contacts) {
            const contentDiv = document.getElementById('contactsContent');

            if (contacts.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üì≠ No hay contactos para mostrar</div>';
                return;
            }

            const contactsHTML = contacts.map(contact => `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üë§ ${escapeHtml(contact.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(contact.fecha_creacion)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(contact.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${contact.telefono}" target="_blank">${escapeHtml(contact.telefono)}</a></div>
                    ${contact.instagram ? `<div class="contact-phone">üì∑ Instagram: ${escapeHtml(contact.instagram)}</div>` : ''}
                    ${contact.facebook ? `<div class="contact-phone">üë• Facebook: ${escapeHtml(contact.facebook)}</div>` : ''}
                    ${contact.club_exclusivo ? `<div class="contact-phone">‚≠ê Club exclusivo: ${escapeHtml(contact.club_exclusivo)}</div>` : ''}
                    <div class="contact-message">
                        <strong>üí¨ Mensaje:</strong><br>
                        ${escapeHtml(contact.mensaje)}
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${contactsHTML}</div>`;
        }

        function displayVip(vips) {
            const contentDiv = document.getElementById('vipContent');

            if (vips.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üì≠ No hay registros VIP para mostrar</div>';
                return;
            }

            const vipHTML = vips.map(vip => `
                <div class="vip-card">
                    <div class="contact-header">
                        <div class="contact-name">üëë ${escapeHtml(vip.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(vip.fecha_creacion)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(vip.email)}</div>
                    <div class="vip-info">
                        <div class="vip-field">
                            <strong>WhatsApp</strong>
                            <span><a href="https://wa.me/${vip.whatsapp}" target="_blank">${escapeHtml(vip.whatsapp)}</a></span>
                        </div>
                        <div class="vip-field">
                            <strong>Boletos</strong>
                            <span>${escapeHtml(vip.boletos)}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${vipHTML}</div>`;
        }

        function displayInscripciones(inscripciones) {
            const contentDiv = document.getElementById('inscripcionesContent');

            if (inscripciones.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üì≠ No hay inscripciones para mostrar</div>';
                return;
            }

            const inscripcionesHTML = inscripciones.map(insc => {
                let proofButtonHtml = '';
                if (insc.comprobante) {
                    const proofId = `proof_${proofCounter++}`;
                    proofsMap[proofId] = {
                        data: insc.comprobante,
                        type: insc.comprobante_tipo || 'image/png'
                    };
                    proofButtonHtml = `<br><button class="btn-view-proof" onclick="viewProofById('${proofId}')">üì∏ Ver comprobante</button>`;
                } else {
                    proofButtonHtml = `<br><button class="btn-view-proof" onclick="uploadInscripcionProof(${insc.id}, '${escapeHtml(insc.nombre)}', '${insc.email}', '${insc.telefono}')">‚¨ÜÔ∏è Subir comprobante</button>`;
                }

                return `
                <div class="inscription-card" data-id="${insc.id}">
                    <div class="contact-header">
                        <div class="contact-name">üèçÔ∏è ${escapeHtml(insc.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(insc.fecha_creacion)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(insc.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${insc.telefono}" target="_blank">${escapeHtml(insc.telefono)}</a></div>
                    ${insc.instagram ? `<div class="contact-phone">üì∑ Instagram: ${escapeHtml(insc.instagram)}</div>` : ''}
                    ${insc.facebook ? `<div class="contact-phone">üë• Facebook: ${escapeHtml(insc.facebook)}</div>` : ''}
                    ${insc.club_exclusivo ? `<div class="contact-phone">‚≠ê Club exclusivo: ${escapeHtml(insc.club_exclusivo)}</div>` : ''}
                    <div class="inscription-details">
                        <strong>üë§ Edad:</strong> ${insc.edad || 'N/A'}<br>
                        <strong>üèçÔ∏è N√∫mero de Moto:</strong> ${escapeHtml(insc.numero_moto || 'N/A')}<br>
                        <strong>üìú N√∫mero de Licencia:</strong> ${escapeHtml(insc.numero_licencia || 'N/A')}<br>
                        <strong>üèÜ Categor√≠a:</strong> ${escapeHtml(insc.categoria || 'N/A')}<br>
                        <strong>üë• Cantidad de Personas:</strong> ${escapeHtml(insc.cantidad_personas || 'N/A')}<br>
                        <strong>üöó Cantidad de Veh√≠culos:</strong> ${escapeHtml(insc.cantidad_vehiculos || 'N/A')}<br>
                        <strong>üí¨ Mensaje:</strong> ${escapeHtml(insc.mensaje || 'N/A')}
                        ${proofButtonHtml}
                    </div>
                    <button class="generate-qr-btn" onclick="generateQRInscripcion(${insc.id}, '${escapeHtml(insc.nombre)}', '${insc.email}', '${insc.telefono}')">üîê Generar QR</button>
                    <button class="delete-btn" onclick="deleteInscripcion(${insc.id})">üóëÔ∏è Eliminar</button>
                </div>
            `}).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${inscripcionesHTML}</div>`;
        }

        function displayTickets(tickets) {
            const contentDiv = document.getElementById('ticketsContent');

            if (tickets.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üé´ No hay compras de tickets para mostrar</div>';
                return;
            }

            const ticketsHTML = tickets.map((ticket, idx) => {
                let proofButtonHtml = '';
                if (ticket.comprobante) {
                    const proofId = `proof_${proofCounter++}`;
                    proofsMap[proofId] = {
                        data: ticket.comprobante,
                        type: ticket.comprobante_tipo || 'image/png'
                    };
                    proofButtonHtml = `<br><button class="btn-view-proof" onclick="viewProofById('${proofId}')">üì∏ Ver comprobante</button>`;
                }

                return `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üé´ ${escapeHtml(ticket.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(ticket.fecha_compra)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(ticket.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${ticket.telefono}" target="_blank">${escapeHtml(ticket.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Cantidad:</strong> ${ticket.cantidad}<br>
                        <strong>Fecha Evento:</strong> ${ticket.fecha_evento}<br>
                        <strong>Precio:</strong> ${escapeHtml(ticket.precio)}
                        ${proofButtonHtml}
                    </div>
                    <button class="generate-qr-btn" onclick="generateQRTicket(${ticket.id}, '${escapeHtml(ticket.nombre)}', '${ticket.email}', '${ticket.telefono}')">üîê Generar QR</button>
                    <button class="delete-btn" onclick="deleteTicket(${ticket.id})">üóëÔ∏è Eliminar</button>
                </div>
            `}).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${ticketsHTML}</div>`;
        }

        function displayTicketsVip(tickets_vip) {
            const contentDiv = document.getElementById('tickets_vipContent');

            if (tickets_vip.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üé´üëë No hay compras VIP para mostrar</div>';
                return;
            }

            const ticketsVipHTML = tickets_vip.map((ticket, idx) => {
                let proofButtonHtml = '';
                if (ticket.comprobante) {
                    const proofId = `proof_${proofCounter++}`;
                    proofsMap[proofId] = {
                        data: ticket.comprobante,
                        type: ticket.comprobante_tipo || 'image/png'
                    };
                    proofButtonHtml = `<br><button class="btn-view-proof" onclick="viewProofById('${proofId}')">üì∏ Ver comprobante</button>`;
                }

                return `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üé´üëë ${escapeHtml(ticket.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(ticket.fecha_compra)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(ticket.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${ticket.telefono}" target="_blank">${escapeHtml(ticket.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Cantidad:</strong> ${ticket.cantidad}<br>
                        <strong>Duraci√≥n:</strong> ${ticket.duracion} d√≠a(s)<br>
                        <strong>Fecha Evento:</strong> ${ticket.fecha_evento}<br>
                        <strong>Precio:</strong> ${escapeHtml(ticket.precio)}
                        ${proofButtonHtml}
                    </div>
                    <button class="generate-qr-btn" onclick="generateQRTicketVip(${ticket.id}, '${escapeHtml(ticket.nombre)}', '${ticket.email}', '${ticket.telefono}')">üîê Generar QR</button>
                    <button class="delete-btn" onclick="deleteTicketVip(${ticket.id})">üóëÔ∏è Eliminar</button>
                </div>
            `}).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${ticketsVipHTML}</div>`;
        }

        function displayParking(parking) {
            const contentDiv = document.getElementById('parkingContent');

            if (parking.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üÖøÔ∏è No hay estacionamientos para mostrar</div>';
                return;
            }

            const parkingHTML = parking.map((park, idx) => {
                let proofButtonHtml = '';
                if (park.comprobante) {
                    const proofId = `proof_${proofCounter++}`;
                    proofsMap[proofId] = {
                        data: park.comprobante,
                        type: park.comprobante_tipo || 'image/png'
                    };
                    proofButtonHtml = `<br><button class="btn-view-proof" onclick="viewProofById('${proofId}')">üì∏ Ver comprobante</button>`;
                }

                return `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üÖøÔ∏è ${escapeHtml(park.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(park.fecha_compra)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(park.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${park.telefono}" target="_blank">${escapeHtml(park.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Placas:</strong> ${escapeHtml(park.placas)}<br>
                        <strong>Cantidad de Espacios:</strong> ${park.cantidad}<br>
                        <strong>Fecha Evento:</strong> ${park.fecha_evento}<br>
                        <strong>Precio:</strong> ${escapeHtml(park.precio)}
                        ${proofButtonHtml}
                    </div>
                    <button class="generate-qr-btn" onclick="generateQRParking(${park.id}, '${escapeHtml(park.nombre)}', '${park.email}', '${park.telefono}')">üîê Generar QR</button>
                    <button class="delete-btn" onclick="deleteParking(${park.id})">üóëÔ∏è Eliminar</button>
                </div>
            `}).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${parkingHTML}</div>`;
        }

        // Load and display Comprobantes (Payment Proofs)
        async function loadProofsGenerales() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/comprobantes-generales`);
                const result = await response.json();
                if (result.success) {
                    displayProofsGenerales(result.data);
                } else {
                    document.getElementById('comprobantes_generalesContent').innerHTML = '<div class="error">‚ùå Error al cargar los comprobantes</div>';
                }
            } catch (error) {
                console.error('Error loading proofs:', error);
                document.getElementById('comprobantes_generalesContent').innerHTML = '<div class="error">‚ùå Error al conectar con el servidor</div>';
            }
        }

        function displayProofsGenerales(proofs) {
            const contentDiv = document.getElementById('comprobantes_generalesContent');

            if (proofs.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üßæ No hay comprobantes para mostrar</div>';
                return;
            }

            const proofsHTML = proofs.map(proof => `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üßæ ${escapeHtml(proof.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(proof.fecha_carga)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(proof.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${proof.telefono}" target="_blank">${escapeHtml(proof.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Cantidad de Boletos:</strong> ${proof.cantidad}<br>
                        <strong>Total:</strong> ${escapeHtml(proof.total)}<br>
                        <strong>Fecha Evento:</strong> ${proof.fecha_evento}<br>
                        <strong>Comprobante:</strong> <a href="${proof.comprobante_url}" target="_blank">üìé Ver archivo</a>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${proofsHTML}</div>`;
        }

        async function loadProofsVIP() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/comprobantes-vip`);
                const result = await response.json();
                if (result.success) {
                    displayProofsVIP(result.data);
                } else {
                    document.getElementById('comprobantes_vipContent').innerHTML = '<div class="error">‚ùå Error al cargar los comprobantes VIP</div>';
                }
            } catch (error) {
                console.error('Error loading VIP proofs:', error);
                document.getElementById('comprobantes_vipContent').innerHTML = '<div class="error">‚ùå Error al conectar con el servidor</div>';
            }
        }

        function displayProofsVIP(proofs) {
            const contentDiv = document.getElementById('comprobantes_vipContent');

            if (proofs.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üßæüëë No hay comprobantes VIP para mostrar</div>';
                return;
            }

            const proofsHTML = proofs.map(proof => `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üßæüëë ${escapeHtml(proof.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(proof.fecha_carga)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(proof.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${proof.telefono}" target="_blank">${escapeHtml(proof.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Cantidad de Boletos:</strong> ${proof.cantidad}<br>
                        <strong>Duraci√≥n:</strong> ${proof.duracion} d√≠a(s)<br>
                        <strong>Total:</strong> ${escapeHtml(proof.total)}<br>
                        <strong>Fecha Evento:</strong> ${proof.fecha_evento}<br>
                        <strong>Comprobante:</strong> <a href="${proof.comprobante_url}" target="_blank">üìé Ver archivo</a>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${proofsHTML}</div>`;
        }

        async function loadProofsParking() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/comprobantes-estacionamiento`);
                const result = await response.json();
                if (result.success) {
                    displayProofsParking(result.data);
                } else {
                    document.getElementById('comprobantes_parkingContent').innerHTML = '<div class="error">‚ùå Error al cargar los comprobantes de estacionamiento</div>';
                }
            } catch (error) {
                console.error('Error loading parking proofs:', error);
                document.getElementById('comprobantes_parkingContent').innerHTML = '<div class="error">‚ùå Error al conectar con el servidor</div>';
            }
        }

        function displayProofsParking(proofs) {
            const contentDiv = document.getElementById('comprobantes_parkingContent');

            if (proofs.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üßæüÖøÔ∏è No hay comprobantes de estacionamiento para mostrar</div>';
                return;
            }

            const proofsHTML = proofs.map(proof => `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üßæüÖøÔ∏è ${escapeHtml(proof.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(proof.fecha_carga)}</div>
                    </div>
                    <div class="contact-email">üìß ${escapeHtml(proof.email)}</div>
                    <div class="contact-phone">üì± <a href="https://wa.me/${proof.telefono}" target="_blank">${escapeHtml(proof.telefono)}</a></div>
                    <div class="inscription-details">
                        <strong>Placas:</strong> ${escapeHtml(proof.placas)}<br>
                        <strong>Cantidad de Espacios:</strong> ${proof.cantidad}<br>
                        <strong>Total:</strong> ${escapeHtml(proof.total)}<br>
                        <strong>Fecha Evento:</strong> ${proof.fecha_evento}<br>
                        <strong>Comprobante:</strong> <a href="${proof.comprobante_url}" target="_blank">üìé Ver archivo</a>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${proofsHTML}</div>`;
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (currentTab === 'contacts') {
                const filtered = allContacts.filter(contact => {
                    return contact.nombre.toLowerCase().includes(searchTerm) ||
                           contact.email.toLowerCase().includes(searchTerm) ||
                           contact.mensaje.toLowerCase().includes(searchTerm);
                });
                displayContacts(filtered);
            } else if (currentTab === 'vip') {
                const filtered = allVip.filter(vip => {
                    return vip.nombre.toLowerCase().includes(searchTerm) ||
                           vip.email.toLowerCase().includes(searchTerm) ||
                           vip.whatsapp.toLowerCase().includes(searchTerm);
                });
                displayVip(filtered);
            } else if (currentTab === 'inscripciones') {
                const filtered = allInscripciones.filter(insc => {
                    return insc.nombre.toLowerCase().includes(searchTerm) ||
                           insc.email.toLowerCase().includes(searchTerm);
                });
                displayInscripciones(filtered);
            } else if (currentTab === 'tickets') {
                const filtered = allTickets.filter(ticket => {
                    return ticket.nombre.toLowerCase().includes(searchTerm) ||
                           ticket.email.toLowerCase().includes(searchTerm);
                });
                displayTickets(filtered);
            } else if (currentTab === 'tickets_vip') {
                const filtered = allTicketsVip.filter(ticket => {
                    return ticket.nombre.toLowerCase().includes(searchTerm) ||
                           ticket.email.toLowerCase().includes(searchTerm);
                });
                displayTicketsVip(filtered);
            } else if (currentTab === 'parking') {
                const filtered = allParking.filter(park => {
                    return park.nombre.toLowerCase().includes(searchTerm) ||
                           park.email.toLowerCase().includes(searchTerm) ||
                           park.placas.toLowerCase().includes(searchTerm);
                });
                displayParking(filtered);
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        async function deleteInscripcion(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta inscripci√≥n? Esta acci√≥n no puede ser revertida.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/inscripciones/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Inscripci√≥n eliminada exitosamente');
                    loadInscripciones();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la inscripci√≥n');
            }
        }

        async function deleteTicket(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este ticket? Esta acci√≥n no puede ser revertida.')) {
                return;
            }

            try {
                const response = await fetch(`/api/ticket-purchases/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ticket eliminado exitosamente');
                    loadTickets();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el ticket');
            }
        }

        async function deleteTicketVip(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este ticket VIP? Esta acci√≥n no puede ser revertida.')) {
                return;
            }

            try {
                const response = await fetch(`/api/vip-purchases/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Ticket VIP eliminado exitosamente');
                    loadTicketsVip();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el ticket VIP');
            }
        }

        async function deleteParking(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este estacionamiento? Esta acci√≥n no puede ser revertida.')) {
                return;
            }

            try {
                const response = await fetch(`/api/parking-purchases/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('Estacionamiento eliminado exitosamente');
                    loadParking();
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el estacionamiento');
            }
        }

        // Funciones para generar y guardar QR codes
        async function generateQRTicket(id, nombre, email, telefono) {
            await generateAndSaveQR(nombre, email, telefono, `Ticket-${id}`);
        }

        async function generateQRTicketVip(id, nombre, email, telefono) {
            await generateAndSaveQR(nombre, email, telefono, `VIP-${id}`);
        }

        async function generateQRParking(id, nombre, email, telefono) {
            await generateAndSaveQR(nombre, email, telefono, `Parking-${id}`);
        }

        async function generateQRInscripcion(id, nombre, email, telefono) {
            await generateAndSaveQR(nombre, email, telefono, `Inscripcion-${id}`);
        }

        function uploadInscripcionProof(id, nombre, email, telefono) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,application/pdf';

            input.onchange = () => {
                const file = input.files && input.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const result = reader.result || '';
                        const base64Data = result.toString().split(',')[1] || '';

                        const response = await fetch(`${API_BASE_URL}/api/inscription-proof`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                inscripcion_id: id,
                                nombre,
                                email,
                                telefono,
                                comprobante_base64: base64Data,
                                comprobante_tipo: file.type || 'image/png'
                            })
                        });

                        const data = await response.json();
                        if (data.success) {
                            alert('‚úÖ Comprobante subido exitosamente');
                            await loadInscripciones();
                        } else {
                            alert(`‚ùå Error: ${data.message || 'No se pudo subir el comprobante'}`);
                        }
                    } catch (error) {
                        console.error('Error uploading inscription proof:', error);
                        alert('‚ùå Error al subir el comprobante');
                    }
                };

                reader.onerror = () => {
                    alert('‚ùå Error al leer el archivo');
                };

                reader.readAsDataURL(file);
            };

            input.click();
        }

        function loadImageAsync(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        async function generateAndSaveQR(nombre, email, telefono, codigoId) {
            try {
                // Crear datos para el QR
                const qrData = `Nombre: ${nombre}\nEmail: ${email}\nTelefono: ${telefono}\nCodigo: ${codigoId}`;
                
                // Generar QR usando API externa (QRServer)
                const encodedData = encodeURIComponent(qrData);
                const qrImageUrl = `https://api.qrserver.com/v1/create-qr-code/?size=256x256&data=${encodedData}`;
                
                // Obtener la imagen del QR y convertir a Base64
                const response = await fetch(qrImageUrl);
                const blob = await response.blob();
                
                // Convertir blob a Base64
                const reader = new FileReader();
                const qrBase64 = await new Promise((resolve, reject) => {
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });

                // Agregar logo1 en la parte superior del QR
                let finalBase64 = qrBase64;
                try {
                    const qrDataUrl = `data:image/png;base64,${qrBase64}`;
                    const [qrImg, logoImg] = await Promise.all([
                        loadImageAsync(qrDataUrl),
                        loadImageAsync('logo1.png')
                    ]);

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    const maxLogoWidth = Math.min(qrImg.width, 140);
                    const logoScale = maxLogoWidth / logoImg.width;
                    const logoWidth = maxLogoWidth;
                    const logoHeight = Math.round(logoImg.height * logoScale);
                    const padding = 10;

                    canvas.width = qrImg.width;
                    canvas.height = logoHeight + padding + qrImg.height;

                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(logoImg, (canvas.width - logoWidth) / 2, 0, logoWidth, logoHeight);
                    ctx.drawImage(qrImg, 0, logoHeight + padding);

                    finalBase64 = canvas.toDataURL('image/png').split(',')[1];
                } catch (err) {
                    console.warn('No se pudo agregar logo al QR:', err);
                }
                
                // Guardar en la tabla codigos via API
                const saveResponse = await fetch(`${API_BASE_URL}/api/codigos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        imagen: finalBase64,
                        nombre: nombre,
                        correo: email,
                        telefono: telefono
                    })
                });
                
                const data = await saveResponse.json();
                
                if (data.success) {
                    alert('‚úÖ QR generado y guardado exitosamente en la tabla C√≥digos');
                    loadCodigos(); // Actualizar la pesta√±a de c√≥digos
                } else {
                    alert('‚ùå Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error al generar QR:', error);
                alert('‚ùå Error al generar c√≥digo QR: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to view proof using stored ID reference
        function viewProofById(proofId) {
            if (!proofsMap[proofId]) {
                console.error('Proof not found:', proofId);
                alert('Error: No se encontr√≥ el comprobante');
                return;
            }

            const proof = proofsMap[proofId];
            viewProof(proof.data, proof.type);
        }

        // Function to view proof (comprobante) in modal
        function viewProof(base64Data, mimeType) {
            if (!base64Data || base64Data.trim() === '') {
                console.error('No hay datos de comprobante para mostrar');
                alert('Error: No hay datos de comprobante disponibles');
                return;
            }

            const modal = document.getElementById('proofModal');
            const container = document.getElementById('proofContainer');
            
            try {
                // Determine if it's an image or PDF
                if (mimeType && mimeType.includes('pdf')) {
                    // For PDF, create an embed
                    container.innerHTML = `<embed src="data:${mimeType};base64,${base64Data}" type="application/pdf" style="width:100%; height:600px; border-radius:10px;">`;
                } else {
                    // For images, create an img tag
                    container.innerHTML = `<img src="data:${mimeType || 'image/png'};base64,${base64Data}" alt="Comprobante" class="proof-image">`;
                }
                
                modal.style.display = 'block';
            } catch (err) {
                console.error('Error al mostrar comprobante:', err);
                container.innerHTML = '<div style="color: red; padding: 20px;">Error al cargar la imagen/documento</div>';
                modal.style.display = 'block';
            }
        }

        // Close modal when clicking the X
        function closeProofModal() {
            const modal = document.getElementById('proofModal');
            modal.style.display = 'none';
        }

        // Funciones para C√≥digos
        async function loadCodigos() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/codigos`);
                const data = await response.json();

                if (data.success && data.data) {
                    allCodigos = data.data;
                    displayCodigos(allCodigos);
                } else {
                    document.getElementById('codigosContent').innerHTML = '<div class="no-contacts">üì≠ No hay c√≥digos registrados</div>';
                }
            } catch (error) {
                console.error('Error loading codes:', error);
                document.getElementById('codigosContent').innerHTML = '<div class="error">‚ùå Error al cargar los c√≥digos</div>';
            }
        }

        function displayCodigos(codigos) {
            const contentDiv = document.getElementById('codigosContent');

            if (codigos.length === 0) {
                contentDiv.innerHTML = '<div class="no-contacts">üîê No hay c√≥digos para mostrar</div>';
                return;
            }

            const codigosHTML = codigos.map(codigo => `
                <div class="contact-card">
                    <div class="contact-header">
                        <div class="contact-name">üîê ${escapeHtml(codigo.nombre)}</div>
                        <div class="contact-date">üìÖ ${formatDate(codigo.fecha_creacion)}</div>
                    </div>
                    <div class="inscription-details">
                        <strong>Correo:</strong> ${escapeHtml(codigo.correo)}<br>
                        <strong>Tel√©fono:</strong> <a href="https://wa.me/${codigo.telefono}" target="_blank">üì± ${escapeHtml(codigo.telefono)}</a><br>
                        <strong>C√≥digo/Imagen:</strong><br>
                        <img src="data:image/png;base64,${codigo.imagen.substring(0, 100)}..." alt="C√≥digo" style="max-width: 150px; margin-top: 10px; cursor: pointer;" onclick="viewCodigoImage('${codigo.id}')">
                        <br>
                        <button onclick="downloadCodigoImage('${codigo.id}', '${codigo.nombre}')" style="margin-top: 10px; margin-right: 5px; padding: 8px 15px; background: #b8242f; color: white; border: none; border-radius: 5px; cursor: pointer;">‚¨áÔ∏è Descargar</button>
                        <button onclick="deleteCodigo('${codigo.id}')" style="margin-top: 10px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');

            contentDiv.innerHTML = `<div class="contacts-grid">${codigosHTML}</div>`;
        }

        function viewCodigoImage(codigoId) {
            // Obtener la imagen del c√≥digo y mostrarla en el modal
            const modal = document.getElementById('proofModal');
            const container = document.getElementById('proofContainer');
            
            try {
                // Buscar el c√≥digo en la lista
                const codigo = allCodigos.find(c => c.id == codigoId);
                if (codigo && codigo.imagen) {
                    container.innerHTML = `<img src="data:image/png;base64,${codigo.imagen}" alt="C√≥digo" class="proof-image" style="max-width: 100%; max-height: 600px;">`;
                    modal.style.display = 'block';
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        function downloadCodigoImage(codigoId, nombre) {
            try {
                const codigo = allCodigos.find(c => c.id == codigoId);
                if (codigo && codigo.imagen) {
                    const link = document.createElement('a');
                    link.href = 'data:image/png;base64,' + codigo.imagen;
                    link.download = `codigo-${nombre}.png`;
                    link.click();
                }
            } catch (err) {
                console.error('Error descargando:', err);
            }
        }

        async function deleteCodigo(codigoId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este c√≥digo?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/codigos/${codigoId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ C√≥digo eliminado exitosamente');
                    loadCodigos();
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error al eliminar c√≥digo');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('proofModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
    <!-- Modal for viewing proofs -->
    <div id="proofModal" class="proof-modal">
        <div class="proof-modal-content">
            <span class="proof-modal-close" onclick="closeProofModal()">&times;</span>
            <h2 style="color: #b8242f; margin-bottom: 20px;">Comprobante de Pago</h2>
            <div id="proofContainer"></div>
        </div>
    </div>

</body>
</html>
